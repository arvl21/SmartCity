{% extends "base.html" %}
{% load static %}

{% block extra_css %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
<style>
    /* Стили для карты */
    #map {
        height: 400px;
        width: 100%;
        margin: 20px 0;
    }

    /* Стили для подсказок адресов */
    .address-suggestions {
        position: absolute;
        z-index: 1000;
        width: calc(100% - 30px);
        max-height: 200px;
        overflow-y: auto;
        background: white;
        border: 1px solid #ddd;
        border-radius: 4px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        display: none;
    }

    .address-suggestion {
        padding: 8px 12px;
        cursor: pointer;
    }

    .address-suggestion:hover {
        background-color: #f5f5f5;
    }

    /* Стили для превью изображений */
    .image-preview {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        margin-top: 10px;
    }

    .image-preview-item {
        position: relative;
        width: 100px;
        height: 100px;
    }

    .image-preview-item img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    .remove-image {
        position: absolute;
        top: 0;
        right: 0;
        background: red;
        color: white;
        border: none;
        border-radius: 50%;
        width: 20px;
        height: 20px;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    /* Дополнительные стили формы */
    .form-group {
        margin-bottom: 1rem;
        position: relative;
    }
</style>
{% endblock %}

{% block content %}
<div class="container mt-4">
    <h2>Сообщить о проблеме</h2>

    <form method="post" enctype="multipart/form-data" id="problem-form">
        {% csrf_token %}

        <!-- Тип проблемы -->
        <div class="form-group">
            <label for="id_problem_type">Тип проблемы</label>
            {{ form.problem_type }}
        </div>

        <!-- Краткое описание -->
        <div class="form-group">
            <label for="id_short_description">Краткое описание</label>
            {{ form.short_description }}
            <small class="form-text text-muted">До 200 символов</small>
        </div>

        <!-- Подробное описание -->
        <div class="form-group">
            <label for="id_full_description">Подробное описание</label>
            {{ form.full_description }}
            <small class="form-text text-muted">До 1000 символов</small>
        </div>

        <!-- Поле адреса с подсказками -->
        <div class="form-group">
            <label for="id_address">Адрес</label>
            <input type="text" id="id_address" name="address" class="form-control"
                   value="{{ form.address.value|default:'' }}" required
                   placeholder="Начните вводить адрес...">
            <div id="address-suggestions" class="address-suggestions"></div>
        </div>

        <!-- Скрытые поля для координат -->
        <input type="hidden" id="id_latitude" name="latitude" value="{{ form.latitude.value|default:'' }}">
        <input type="hidden" id="id_longitude" name="longitude" value="{{ form.longitude.value|default:'' }}">

        <!-- Карта -->
        <div id="map"></div>

        <!-- Загрузка фото -->
        <div class="form-group mt-3">
            <label for="id_images">Фотографии проблемы</label>
            <input type="file" id="id_images" name="images" class="form-control" multiple
                   accept="image/jpeg,image/png">
            <small class="form-text text-muted">Можно загрузить до 3 фото (JPG/PNG, до 5MB каждое)</small>
            <div class="image-preview" id="image-preview"></div>
        </div>

        <button type="submit" class="btn btn-primary mt-3">Отправить заявку</button>
    </form>
</div>
{% endblock %}

{% block extra_js %}
<script src="{% static 'js/address_suggest.js' %}"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Загрузка Яндекс карт
    function loadYandexMaps() {
        return new Promise((resolve, reject) => {
            if (typeof ymaps !== 'undefined') {
                resolve();
                return;
            }

            const script = document.createElement('script');
            script.src = `https://api-maps.yandex.ru/2.1/?apikey={{ YANDEX_MAPS_API_KEY }}&lang=ru_RU`;
            script.onload = resolve;
            script.onerror = reject;
            document.head.appendChild(script);
        });
    }

    // Инициализация карты для СПб
    function initMap() {
        ymaps.ready(function() {
            const map = new ymaps.Map('map', {
                center: [59.9386, 30.3141],  // Дворцовая площадь, СПб
                zoom: 12,
                controls: ['zoomControl', 'typeSelector', 'fullscreenControl']
            });

            // Создаем метку
            const marker = new ymaps.Placemark(map.getCenter(), {}, {
                draggable: true,
                preset: 'islands#redDotIcon'
            });
            map.geoObjects.add(marker);

            // Обработка перемещения метки
            marker.events.add('dragend', function(e) {
                const coords = e.get('target').geometry.getCoordinates();
                document.getElementById('id_latitude').value = coords[0];
                document.getElementById('id_longitude').value = coords[1];
            });

            // Обработка выбора адреса из подсказок
            document.addEventListener('addressSelected', function(e) {
                const coords = e.detail.coordinates;
                map.setCenter(coords, 15);
                marker.geometry.setCoordinates(coords);
            });
        });
    }

    // Загрузка и инициализация
    loadYandexMaps()
        .then(initMap)
        .catch(error => {
            console.error('Yandex Maps load error:', error);
            document.getElementById('map').innerHTML =
                '<div class="alert alert-danger">Не удалось загрузить карты</div>';
        });
});
</script>
{% endblock %}